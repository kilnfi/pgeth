name: sync

on:
  push:
    branches:
      - "pgeth"
  schedule:
    - cron: "0 * * * *" # every hour

env:
  PLUGINS:
    - "pgeth-monitoring"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: "prepare sync operations"
        run: |
          git remote add geth https://github.com/ethereum/go-ethereum
          git checkout master
          git fetch geth master
      - name: "check if diff exists"
        id: diffcheck
        run: echo "stdout=$(git diff master geth/master -- | wc -c)" >> $GITHUB_OUTPUT
      - name: "perform sync operations"
        if: steps.diffcheck.outputs.stdout != '0'
        run: |
          git reset --hard geth/master
          git push origin master --force
          git checkout pgeth
          git config --global user.email "iulian@rotaru.fr"
          git config --global user.name "mortimr"
          git rebase --stat origin/master

  build-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        plugins: "${{ env.PLUGINS }}"
    steps:
      - name: "build the docker image to ensure project still builds"
        if: steps.diffcheck.outputs.stdout != '0'
        run: docker build .  -f Dockerfile.plugins --tag ghcr.io/kilnfi/${{ matrix.plugins }}:latest --tag ghcr.io/kilnfi/${{ matrix.plugins }}:${GITHUB_SHA} --build-arg PLUGIN_REPOSITORIES="https://github.com/kilnfi/${{ matrix.plugins }}"
      - name: "push rebased pgeth branch"
        if: steps.diffcheck.outputs.stdout != '0'
        run: git push origin pgeth --force
      - name: "login to ghcr"
        if: steps.diffcheck.outputs.stdout != '0'
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: "push to ghcr"
        if: steps.diffcheck.outputs.stdout != '0'
        run: |
          docker push ghcr.io/kilnfi/${{ matrix.plugins }}:latest
          docker push ghcr.io/kilnfi/${{ matrix.plugins }}:${GITHUB_SHA}
